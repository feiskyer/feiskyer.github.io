<!doctype html><html lang=zh-cn>
<head>
<link href=https://gmpg.org/xfn/11 rel=profile>
<link rel=canonical href=https://feisky.xyz/posts/2015-03-03-dive-in-linux-capabilites/>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<meta name=generator content="Hugo 0.87.0">
<title>Dive in Linux capabilites • Feisky</title>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Dive in Linux capabilites">
<meta name=twitter:description content="Introduction Capabilities in Linux are flags that tell the kernel what the application is allowed to do, If you have no additional security mechanism in place, the Linux root user has all capabilities assigned to it. As capabilities are a way for running processes with some privileges, without having the need to grant them root privileges, it is important to understand that they exist. Consider the ping utility. It is">
<meta property="og:title" content="Dive in Linux capabilites">
<meta property="og:description" content="Introduction Capabilities in Linux are flags that tell the kernel what the application is allowed to do, If you have no additional security mechanism in place, the Linux root user has all capabilities assigned to it. As capabilities are a way for running processes with some privileges, without having the need to grant them root privileges, it is important to understand that they exist. Consider the ping utility. It is">
<meta property="og:type" content="article">
<meta property="og:url" content="https://feisky.xyz/posts/2015-03-03-dive-in-linux-capabilites/"><meta property="article:section" content="posts">
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/monokai.min.css>
<link rel=stylesheet href=/scss/hyde-hyde.3081c4981fb69a2783dd36ecfdd0e6ba7a158d4cbfdd290ebce8f78ba0469fc6.css integrity="sha256-MIHEmB+2mieD3Tbs/dDmunoVjUy/3SkOvOj3i6BGn8Y=">
<link rel=stylesheet href=/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58+TzH3icCkSHGoJ+ed7w=" media=print>
<link rel=stylesheet href=/scss/tocbot.5ef07cebc3c477b54270456f149ee02922479bb7555fd344b2c69f953b0e7e5e.css integrity="sha256-XvB868PEd7VCcEVvFJ7gKSJHm7dVX9NEssaflTsOfl4="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]-->
<link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png>
<link rel="shortcut icon" href=/favicon.png>
</head>
<body class=theme-base-0d>
<div class=sidebar>
<div class=container>
<div class=sidebar-about>
<span class=site__title>
<a href=https://feisky.xyz/>
Feisky
</a>
</span>
<div class=author-image>
<img src="https://www.gravatar.com/avatar/f86d2faa0f91793a2163d226d82a7620?s=240&d=mp" class="img--circle img--headshot element--center" alt=gravatar>
</div>
<p class=site__description>
</p>
</div>
<div class=collapsible-menu>
<input type=checkbox id=menuToggle>
<label for=menuToggle>Feisky</label>
<div class=menu-content>
<div>
<ul class=sidebar-nav>
<li>
<a href=https://time.geekbang.org/column/intro/100020901>
<span>Linux性能优化实战</span>
</a>
</li>
<li>
<a href=https://kubernetes.feisky.xyz>
<span>Kubernetes指南</span>
</a>
</li>
<li>
<a href=https://sdn.feisky.xyz>
<span>SDN网络指南</span>
</a>
</li>
<li>
<a href=/assets/mp.png>
<span>微信公众号</span>
</a>
</li>
<li>
<a href=https://zhuanlan.zhihu.com/kubernetes>
<span>知乎专栏</span>
</a>
</li>
<li>
<a href=/about/>
<span>关于我</span>
</a>
</li>
</ul>
</div>
<section class=social>
<a href=https://twitter.com/feisky rel=me><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a>
<a href=https://github.com/feiskyer rel=me><i class="fab fa-github fa-lg" aria-hidden=true></i></a>
</section>
</div>
</div>
<div class=copyright>
&copy; 2021 feiskyer
<a href=https://creativecommons.org/licenses/by-sa/4.0>CC BY-SA 4.0</a>
</div>
<div class=builtwith>
Built with <a href=https://gohugo.io>Hugo</a> ❤️ <a href=https://github.com/htr3n/hyde-hyde>hyde-hyde</a>.
</div>
</div>
</div>
<div class="content container">
<article>
<header>
<h1>Dive in Linux capabilites</h1>
<div class=post__meta>
<br>
<i class="fas fa-tags"></i>
<a class="badge badge-tag" href=/tags/linux>linux</a>
<br>
<i class="fas fa-clock"></i> 1 min read
</div>
</header>
<div class=toc-wrapper>
<input type=checkbox id=tocToggle>
<label for=tocToggle>Table of Content</label>
<div class=toc id=TableOfContents></div>
</div>
<div class=post>
<h3 id=introduction>Introduction</h3>
<p>Capabilities in Linux are flags that tell the kernel what the application is allowed to do, If you have no additional security mechanism in place, the Linux root user has all capabilities assigned to it. As capabilities are a way for running processes with some privileges, without having the need to grant them root privileges, it is important to understand that they exist.</p>
<p>Consider the ping utility. It is marked setuid root on some distributions, because the utility requires the (cap)ability to send raw packets. This capability is known as CAP_NET_RAW. However, thanks to capabilities, you can now mark the ping application with this capability and drop the setuid from the file. As a result, the application does not run with full root privileges anymore, but with the restricted privileges of the user plus one capability, namely the CAP_NET_RAW.</p>
<pre><code>➜  ~  cp /bin/ping .
➜  ~  ll ping
-rwxr-xr-x 1 fei fei 44K  3月  3 14:42 ping
➜  ~  ll /bin/ping
-rwsr-xr-x 1 root root 44K  5月  8  2014 /bin/ping
➜  ~  ./ping -c 1 www.baidu.com
ping: icmp open socket: Operation not permitted
➜  ~  sudo setcap cap_net_raw+p ping
➜  ~  getcap ping
ping = cap_net_raw+p
➜  ~  ./ping -c 1 www.baidu.com
PING www.a.shifen.com (115.239.211.112) 56(84) bytes of data.
64 bytes from 115.239.211.112: icmp_seq=1 ttl=51 time=6.83 ms

--- www.a.shifen.com ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 6.833/6.833/6.833/0.000 ms
</code></pre><h3 id=useful-tools>Useful Tools</h3>
<p>Install capability tools by <code>sudo apt-get install libcap-ng-utils</code>.</p>
<ul>
<li>filecap - a program to see file capabilities</li>
<li>pscap - a program to see process capabilities</li>
<li>netcap - a program to see network capabilities</li>
</ul>
<h3 id=another-exmaple>Another exmaple</h3>
<p>Use following program for test cap_setuid and cap_setgid.</p>
<pre><code>/*
 * gcc cap_test.c -o test -lcap
**/
#include &lt;unistd.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;errno.h&gt;
#include &lt;sys/capability.h&gt;
#include &lt;sys/prctl.h&gt;
#include &lt;sys/types.h&gt;

int main(int argc, char **argv)
{
    printf(&quot;cap_setuid and cap_setgid: %d\n&quot;, prctl(PR_CAPBSET_READ, CAP_SETUID | CAP_SETGID, 0, 0, 0));
    printf(&quot;File cap: %s\n&quot;, cap_to_text(cap_get_file(argv[0]), NULL));
    printf(&quot;Process cap: %s\n&quot;, cap_to_text(cap_get_proc(), NULL));
    if (setresuid(0, 0, 0))
    {
        printf(&quot;setresuid(): %s\n&quot;, strerror(errno));
    }
    else
    {
        char *args[] = {NULL};
        char *env[] = {NULL};
        execve(&quot;/bin/sh&quot;, args, env);
    }
}
</code></pre><p>Since <code>test</code> has no capabilities of cap_setuid and cap_setgid, <code>test</code> program is not permitted to setresuid().</p>
<pre><code>➜  gcc cap_test.c -o test -lcap
➜  ./test
cap_setuid and cap_setgid: 1
File cap: (null)
Process cap: =
setresuid(): Operation not permitted
</code></pre><p>Now, we add cap_setuid and cap_setgid to <code>test</code>:</p>
<pre><code>➜  sudo setcap cap_setuid,cap_setgid+ep test
➜  ./test
cap_setuid and cap_setgid: 1
File cap: = cap_setgid,cap_setuid+ep
Process cap: = cap_setgid,cap_setuid+ep
# cat /etc/shadow   # We are in sh now and we have root priviledge
root:!:11111:0:99999:7:::
daemon:*:12232:0:99999:7:::
...
</code></pre><h3 id=reference>Reference</h3>
<p>See more at <a href=http://man7.org/linux/man-pages/man7/capabilities.7.html>man</a> and <a href=https://www.kernel.org/pub/linux/libs/security/linux-privs/kernel-2.2/capfaq-0.2.txt>faq</a>.</p>
</div>
<div class="navigation navigation-single">
<a href=/posts/2015-01-27-docker/ class=navigation-prev>
<i aria-hidden=true class="fa fa-chevron-left"></i>
<span class=navigation-tittle>Docker</span>
</a>
<a href=/posts/2015-02-05-deploy-a-mesos-cluster-using-docker/ class=navigation-next>
<span class=navigation-tittle>Deploy a Mesos Cluster Using Docker</span>
<i aria-hidden=true class="fa fa-chevron-right"></i>
</a>
</div>
<div class=post__related>
<h2>Related Articles</h2>
<ul class=related-posts>
<li>
<span class=list__title--small>
<a href=/posts/2020-06-06-linux-perf/>10个问题带你全面理解Linux性能优化</a>
<time class="pull-right hidden-tablet">Jun 20 '20</time>
</span>
</li>
<li>
<span class=list__title--small>
<a href=/posts/2015-03-18-how-to-disable-ubuntu-services/>How to disable ubuntu services</a>
</span>
</li>
<li>
<span class=list__title--small>
<a href=/posts/2015-02-15-installing-realtek-rltwifi-driver-for-ubuntu-1410/>Installing Realtek rltwifi driver for Ubuntu 14.10</a>
</span>
</li>
<li>
<span class=list__title--small>
<a href=/posts/2015-03-04-linux-kernel-network-call-flow/>Linux kernel network call flow</a>
</span>
</li>
<li>
<span class=list__title--small>
<a href=/posts/2015-02-12-linux-netcat-examples/>Linux netcat examples</a>
</span>
</li>
</ul>
</div>
<div id=disqus_thread></div>
<script type=text/javascript>(function(){var a,b;if(location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='feisky',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script>
<noscript>
Please enable JavaScript to view the
<a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a>
</noscript>
<a href=http://disqus.com/ class=dsq-brlink>comments powered by
<span class=logo-disqus>Disqus</span>
</a>
</article>
</div>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-69699206-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<script defer src=https://use.fontawesome.com/releases/v5.12.1/js/all.js integrity=sha384-ZbbbT1gw3joYkKRqh0kWyRp32UAvdqkpbLedQJSlnI8iLQcFVxaGyrOgOJiDQTTR crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js></script>
<script type=text/javascript>hljs.initHighlightingOnLoad()</script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.js></script>
<script type=text/javascript>tocbot&&tocbot.init({tocSelector:'.toc',contentSelector:'.post',headingSelector:'h2, h3, h4',collapseDepth:4})</script>
</body>
</html>